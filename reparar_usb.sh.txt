
#!/bin/bash

LOGFILE="reparacion_usb_$(date +%Y%m%d_%H%M%S).log"

echo "Iniciando búsqueda de unidades USB conectadas..." | tee -a "$LOGFILE"

# Listar dispositivos USB conectados
lsblk -o NAME,TRAN,MOUNTPOINT,LABEL,SIZE,TYPE | grep usb | tee -a "$LOGFILE"

echo
echo "Dispositivos USB detectados:"
USB_DEVICES=($(lsblk -d -o NAME,TRAN | grep usb | awk '{print $1}'))

if [ ${#USB_DEVICES[@]} -eq 0 ]; then
    echo "No se detectaron unidades USB." | tee -a "$LOGFILE"
    exit 1
fi

for i in "${!USB_DEVICES[@]}"; do
    echo "$((i+1)). /dev/${USB_DEVICES[$i]}"
done

echo
read -p "Selecciona el número de la unidad USB que quieres reparar: " choice

if ! [[ "$choice" =~ ^[0-9]+$ ]] || [ "$choice" -lt 1 ] || [ "$choice" -gt "${#USB_DEVICES[@]}" ]; then
    echo "Selección inválida." | tee -a "$LOGFILE"
    exit 1
fi

DEVICE="/dev/${USB_DEVICES[$((choice-1))]}"

echo "Has seleccionado $DEVICE" | tee -a "$LOGFILE"

read -p "¿Quieres reparar la unidad $DEVICE? (s/n): " confirm
if [[ ! "$confirm" =~ ^[Ss]$ ]]; then
    echo "Operación cancelada." | tee -a "$LOGFILE"
    exit 0
fi

echo "Desmontando $DEVICE..." | tee -a "$LOGFILE"
sudo umount ${DEVICE}?* 2>/dev/null

echo "Detectando sistema de archivos..." | tee -a "$LOGFILE"
FS_TYPE=$(lsblk -no FSTYPE $DEVICE)

if [ -z "$FS_TYPE" ]; then
    echo "No se pudo detectar el sistema de archivos. Se usará fsck por defecto." | tee -a "$LOGFILE"
    FS_TYPE="auto"
fi

echo "Sistema de archivos detectado: $FS_TYPE" | tee -a "$LOGFILE"

echo "Iniciando reparación..." | tee -a "$LOGFILE"

case "$FS_TYPE" in
    vfat|fat32|msdos)
        sudo dosfsck -a $DEVICE | tee -a "$LOGFILE"
        ;;
    ntfs)
        sudo ntfsfix $DEVICE | tee -a "$LOGFILE"
        ;;
    ext2|ext3|ext4)
        sudo fsck -y $DEVICE | tee -a "$LOGFILE"
        ;;
    *)
        echo "Sistema de archivos no reconocido o no soportado, intentando fsck genérico." | tee -a "$LOGFILE"
        sudo fsck -y $DEVICE | tee -a "$LOGFILE"
        ;;
esac

echo "Reparación finalizada. Revisa el log en $LOGFILE"